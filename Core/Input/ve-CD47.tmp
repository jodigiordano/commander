namespace Core.Input
{
    using System;
    using System.Collections.Generic;
    using Microsoft.Xna.Framework;
    using Microsoft.Xna.Framework.Input;
    using MultiInput;

    class InputController
    {
        private bool Active;
        
        private Dictionary<PlayerIndex, Dictionary<Keys, bool>> KeysPressed;
        private Dictionary<PlayerIndex, Dictionary<Keys, bool>> KeysPressedOnce;
        private Dictionary<PlayerIndex, Dictionary<Keys, bool>> KeysReleased;

        private Dictionary<PlayerIndex, Dictionary<MouseButton, bool>> MouseButtonsPressed;
        private Dictionary<PlayerIndex, Dictionary<MouseButton, bool>> MouseButtonsPressedOnce;
        private Dictionary<PlayerIndex, Dictionary<MouseButton, bool>> MouseButtonsReleased;
        private Dictionary<PlayerIndex, int> MouseScrolled;
        private Dictionary<PlayerIndex, MouseState> MouseStatePrevious;
        private Dictionary<PlayerIndex, MouseState> MouseStateNow;
        private Dictionary<PlayerIndex, RawMouse> MouseRaw;
        private Vector2 MouseBasePosition;
        private MultiInputController MouseController;
        
        private Dictionary<PlayerIndex, Dictionary<Buttons, bool>> GamePadButtonsPressed;
        private Dictionary<PlayerIndex, Dictionary<Buttons, bool>> GamePadButtonsReleased;
        private Dictionary<PlayerIndex, Dictionary<Buttons, float>> GamePadJoystickMoved;

        private List<InputListener> Listeners;

        private Dictionary<PlayerIndex, List<Keys>> AllKeys;
        private Dictionary<PlayerIndex, List<MouseButton>> AllMouseButtons;
        private Dictionary<PlayerIndex, List<Buttons>> AllGamePadButtons;


        public InputController()
        {
            Active = true;
            
            KeysPressed = new Dictionary<PlayerIndex, Dictionary<Keys, bool>>(4);
            KeysPressedOnce = new Dictionary<PlayerIndex, Dictionary<Keys, bool>>(4);
            KeysReleased = new Dictionary<PlayerIndex, Dictionary<Keys, bool>>(4);

            MouseButtonsPressed = new Dictionary<PlayerIndex, Dictionary<MouseButton, bool>>(4);
            MouseButtonsPressedOnce = new Dictionary<PlayerIndex, Dictionary<MouseButton, bool>>(4);
            MouseButtonsReleased = new Dictionary<PlayerIndex, Dictionary<MouseButton, bool>>(4);
            MouseScrolled = new Dictionary<PlayerIndex, int>(4);
            MouseStatePrevious = new Dictionary<PlayerIndex, MouseState>(4);
            MouseStateNow = new Dictionary<PlayerIndex, MouseState>(4);
            MouseBasePosition = Vector2.Zero;
            MouseRaw = new Dictionary<PlayerIndex, RawMouse>(4);
            MouseController = new MultiInputController(Mouse.WindowHandle);

            GamePadButtonsPressed = new Dictionary<PlayerIndex, Dictionary<Buttons, bool>>(4);
            GamePadButtonsReleased = new Dictionary<PlayerIndex, Dictionary<Buttons, bool>>(4);
            GamePadJoystickMoved = new Dictionary<PlayerIndex, Dictionary<Buttons, float>>(4);

            int i = 0;

            for (PlayerIndex player = PlayerIndex.One; player <= PlayerIndex.Four; player++)
            {
                KeysPressed.Add(player, new Dictionary<Keys, bool>(120));
                KeysPressedOnce.Add(player, new Dictionary<Keys, bool>(120));
                KeysReleased.Add(player, new Dictionary<Keys, bool>(120));

                MouseButtonsPressed.Add(player, new Dictionary<MouseButton, bool>(10));
                MouseButtonsPressedOnce.Add(player, new Dictionary<MouseButton, bool>(10));
                MouseButtonsReleased.Add(player, new Dictionary<MouseButton, bool>(10));
                MouseScrolled.Add(player, 0);
                MouseStatePrevious.Add(player, Mouse.GetState());
                MouseStateNow.Add(player, Mouse.GetState());
                MouseRaw.Add(player, MouseController.Mice[Math.Min(i, MouseController.MiceCount)]);
                
                GamePadButtonsPressed.Add(player, new Dictionary<Buttons, bool>(30));
                GamePadButtonsReleased.Add(player, new Dictionary<Buttons, bool>(30));
                GamePadJoystickMoved.Add(player, new Dictionary<Buttons, float>(30));

                i++;
            }

            Listeners = new List<InputListener>();

            AllKeys = new Dictionary<PlayerIndex, List<Keys>>(4);
            AllMouseButtons = new Dictionary<PlayerIndex, List<MouseButton>>(4);
            AllGamePadButtons = new Dictionary<PlayerIndex, List<Buttons>>(4);

            Visuel.Facade.etreNotifierTransition(doTransitionStarted, doTransitionStopped);
        }


        public void Initialize()
        {
            Active = true;

            for (PlayerIndex player = PlayerIndex.One; player <= PlayerIndex.Four; player++)
            {
                this.addKeys(player, new List<Keys>());
                this.addMouseButtons(player, new List<MouseButton>());

                GamePadButtonsPressed[player].Clear();
                GamePadButtonsReleased[player].Clear();
                GamePadJoystickMoved[player].Clear();
            }

            MouseBasePosition = Vector2.Zero;

            Listeners.Clear();
        }


        public void Dispose()
        {
            MouseController.Dispose();
        }


        public void addListener(InputListener listener)
        {
            Listeners.Add(listener);
        }


        private void doTransitionStarted(object sender, EventArgs e)
        {
            this.Active = false;
        }


        private void doTransitionStopped(object sender, EventArgs e)
        {
            this.Active = true;
        }


        public void addKeys(PlayerIndex player, List<Keys> keys)
        {
            AllKeys[player].Clear();
            AllKeys[player].AddRange(keys);

            KeysPressed[player].Clear();
            KeysPressedOnce[player].Clear();
            KeysReleased[player].Clear();

            foreach (var key in keys)
            {
                KeysPressed[player].Add(key, false);
                KeysPressedOnce[player].Add(key, false);
                KeysReleased[player].Add(key, false);
            }
        }


        public void addMouseButtons(PlayerIndex player, List<MouseButton> buttons)
        {
            AllMouseButtons[player].Clear();
            AllMouseButtons[player].AddRange(buttons);

            MouseButtonsPressed[player].Clear();
            MouseButtonsPressedOnce[player].Clear();
            MouseButtonsReleased[player].Clear();
            MouseScrolled[player] = 0;
            MouseStatePrevious[player] = Mouse.GetState();
            MouseStateNow[player] = Mouse.GetState();

            foreach (var button in buttons)
            {
                MouseButtonsPressed[player].Add(button, false);
                MouseButtonsPressedOnce[player].Add(button, false);
                MouseButtonsReleased[player].Add(button, false);
            }
        }


        public void Update(GameTime gameTime)
        {
            doKeyboardInput();
            doMouseInput();
        }

        private void doMouseInput()
        {
            // Receive raw input
            foreach (var kvp in MouseRaw)
            {
                foreach (var button in AllMouseButtons[kvp.Key])
                {
                    bool before = MouseButtonsPressed[kvp.Key][button];
                    bool now = false;

                    switch (button)
                    {
                        case MouseButton.Left:
                            now = kvp.Value.Buttons[0];
                            break;

                        case MouseButton.Right:
                            now = kvp.Value.Buttons[1];
                            break;

                        case MouseButton.Middle:
                            now = kvp.Value.Buttons[2];
                            break;
                    }

                    MouseButtonsPressed[kvp.Key][button] = now;
                    MouseButtonsPressedOnce[kvp.Key][button] = !before && now;
                    MouseButtonsReleased[kvp.Key][button] = before && !now;
                }
            }

            // Spread the word
            foreach (var listener in Listeners)
            {
                if (!listener.Active)
                    continue;

                foreach (var kvp in AllMouseButtons) //foreach player
                {
                    foreach (var keyboardkey in kvp.Value) //foreach keyboard key
                    {
                        if (KeysPressedOnce[kvp.Key][keyboardkey])
                            listener.doKeyPressedOnce(kvp.Key, keyboardkey);

                        if (KeysReleased[kvp.Key][keyboardkey])
                            listener.doKeyReleased(kvp.Key, keyboardkey);
                    }
                }
            }
        }

        private void doKeyboardInput()
        {
            // Receive raw input
            KeyboardState keyboardState = Keyboard.GetState();

            foreach (var kvp in AllKeys)
            {
                foreach (var keyboardkey in kvp.Value)
                {
                    bool before = KeysPressed[kvp.Key][keyboardkey];
                    bool now = keyboardState.IsKeyDown(keyboardkey);

                    KeysPressed[kvp.Key][keyboardkey] = now;
                    KeysPressedOnce[kvp.Key][keyboardkey] = !before && now;
                    KeysReleased[kvp.Key][keyboardkey] = before && !now;
                }
            }


            // Spread the word
            foreach (var listener in Listeners)
            {
                if (!listener.Active)
                    continue;

                foreach (var kvp in AllKeys) //foreach player
                {
                    foreach (var keyboardkey in kvp.Value) //foreach keyboard key
                    {
                        if (KeysPressedOnce[kvp.Key][keyboardkey])
                            listener.doKeyPressedOnce(kvp.Key, keyboardkey);

                        if (KeysReleased[kvp.Key][keyboardkey])
                            listener.doKeyReleased(kvp.Key, keyboardkey);
                    }
                }
            }
        }
    }
}
